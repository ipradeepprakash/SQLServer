



/* 

	Always on AG - TCP endpoints checking

*/

	select * from sys.endpoints
	select name, port,* from sys.tcp_endpoints



/* cluster info */

	select * from sys.dm_hadr_cluster
	select * from sys.dm_hadr_cluster_members
	select * from sys.dm_hadr_cluster_networks
	select * from sys.availability_groups
	select * from sys.availability_groups_cluster
	select * from sys.dm_hadr_availability_group_states
	select * from sys.availability_replicas
	select * from sys.dm_hadr_availability_replica_cluster_nodes
	select * from sys.dm_hadr_availability_replica_cluster_states
	select * from sys.dm_hadr_availability_replica_states
	select * from sys.dm_hadr_auto_page_repair
	select * from sys.dm_hadr_database_replica_states
	select * from sys.dm_hadr_database_replica_cluster_states
	select * from sys.availability_group_listener_ip_addresses
	select * from sys.availability_group_listeners
	select * from sys.dm_tcp_listener_states

	-- check Db status in AG
	select 
			db_name(database_id) as [Database], is_primary_replica, synchronization_state_desc,database_state_desc,
			is_suspended,suspend_reason_desc, recovery_lsn,truncation_lsn, last_sent_lsn,last_sent_time,
			last_received_lsn, last_received_time, last_hardened_lsn, log_send_queue_size,
			log_send_rate,redo_queue_size, redo_rate,end_of_log_lsn, last_commit_lsn,last_commit_time,
			secondary_lag_seconds
  from sys.dm_hadr_database_replica_states


	
-- Pending sync Reason
	SELECT 
		ag.name AS [availability_group_name]
		, d.name AS [database_name]
		, ar.replica_server_name AS [replica_instance_name]
		, drs.truncation_lsn , drs.log_send_queue_size
		, drs.redo_queue_size
	FROM sys.availability_groups ag
		INNER JOIN sys.availability_replicas ar
			ON ar.group_id = ag.group_id
		INNER JOIN sys.dm_hadr_database_replica_states drs
			ON drs.replica_id = ar.replica_id
		INNER JOIN sys.databases d
			ON d.database_id = drs.database_id
	WHERE drs.is_local=0
	ORDER BY ag.name ASC, d.name ASC, drs.truncation_lsn ASC, ar.replica_server_name ASC


-- sync status



--Show Availability groups visible to the Server and Replica information such as Which server is the Primary
--Sync and Async modes , Readable Secondary and Failover Mode, these can all be filtered using a Where clause
--if you are running some checks, no Where clause will show you all of the information.
		WITH AGStatus AS(
		SELECT
			name as AGname,
			replica_server_name,
		CASE WHEN  (primary_replica  = replica_server_name) THEN  1
		ELSE  '' END AS IsPrimaryServer,
		secondary_role_allow_connections_desc AS ReadableSecondary,
		[availability_mode]  AS [Synchronous],
		failover_mode_desc
		FROM master.sys.availability_groups Groups
		INNER JOIN master.sys.availability_replicas Replicas ON Groups.group_id = Replicas.group_id
		INNER JOIN master.sys.dm_hadr_availability_group_states States ON Groups.group_id = States.group_id
		)
 
		Select
			[AGname], 			[Replica_server_name], 			[IsPrimaryServer],
			[Synchronous], 			[ReadableSecondary], 			[Failover_mode_desc]
		FROM AGStatus 
		--WHERE
		--IsPrimaryServer = 1
		--AND Synchronous = 1
		ORDER BY 		AGname ASC, 		IsPrimaryServer DESC;


-- AG name, Replica Server, Readable Secondary, Failover Modes
		DECLARE @HADRSERVERNAME VARCHAR(25) 
		SET @HADRSERVERNAME = @@SERVERNAME 
		SELECT CLUSTERNODES.GROUP_NAME          AS [AVAILABILITY GROUP NAME], 
			   CLUSTERNODES.REPLICA_SERVER_NAME AS [AVAILABILITY REPLICA NAME], 
			   CLUSTERNODES.NODE_NAME           AS [AVAILABILITY NODE], 
			   RS.ROLE_DESC                     AS [ROLE], 
			   DB_NAME(DRS.DATABASE_ID)         AS [AVAILABILITY DATABASE], 
			   DRS.SYNCHRONIZATION_STATE_DESC   AS [SYNCHRONIZATION STATUS], 
			   DRS.SYNCHRONIZATION_HEALTH_DESC  AS [SYNCHRONIZATION HEALTH] 
		FROM   SYS.DM_HADR_AVAILABILITY_REPLICA_CLUSTER_NODES CLUSTERNODES 
			   JOIN SYS.DM_HADR_AVAILABILITY_REPLICA_CLUSTER_STATES CLUSTERSTATS 
				 ON CLUSTERNODES.REPLICA_SERVER_NAME = CLUSTERSTATS.REPLICA_SERVER_NAME 
			   JOIN SYS.DM_HADR_AVAILABILITY_REPLICA_STATES RS 
				 ON RS.REPLICA_ID = CLUSTERSTATS.REPLICA_ID 
			   JOIN SYS.DM_HADR_DATABASE_REPLICA_STATES DRS 
				 ON RS.REPLICA_ID = DRS.REPLICA_ID 
		WHERE  CLUSTERNODES.REPLICA_SERVER_NAME <> @HADRSERVERNAME

